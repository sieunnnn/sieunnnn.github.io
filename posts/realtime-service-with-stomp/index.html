<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="ko" data-mode="light">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Stomp 를 사용하여 실시간 서비스 개발하기" />
<meta name="author" content="김자바" />
<meta property="og:locale" content="ko" />
<meta name="description" content="실시간 서비스에서 security 는 어떻게 적용해야 할까? 에 대한 고민을 담은 글입니다." />
<meta property="og:description" content="실시간 서비스에서 security 는 어떻게 적용해야 할까? 에 대한 고민을 담은 글입니다." />
<link rel="canonical" href="https://sieunnnn.github.io/posts/realtime-service-with-stomp/" />
<meta property="og:url" content="https://sieunnnn.github.io/posts/realtime-service-with-stomp/" />
<meta property="og:site_name" content="김자바의 개발일지" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-23T12:33:00+09:00" />
<meta property="og:image" content="https://sieunnnn.github.io/assets/img/profile.jpg" /><meta name="twitter:card" content="summary_large_image" />
      <meta property="twitter:image" content="https://sieunnnn.github.io/assets/img/profile.jpg" />
<meta property="twitter:title" content="Stomp 를 사용하여 실시간 서비스 개발하기" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"김자바"},"dateModified":"2024-05-23T12:33:00+09:00","datePublished":"2024-05-23T12:33:00+09:00","description":"실시간 서비스에서 security 는 어떻게 적용해야 할까? 에 대한 고민을 담은 글입니다.","headline":"Stomp 를 사용하여 실시간 서비스 개발하기","mainEntityOfPage":{"@type":"WebPage","@id":"https://sieunnnn.github.io/posts/realtime-service-with-stomp/"},"url":"https://sieunnnn.github.io/posts/realtime-service-with-stomp/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Stomp 를 사용하여 실시간 서비스 개발하기 | 김자바의 개발일지
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="김자바의 개발일지">
<meta name="application-name" content="김자바의 개발일지">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js,npm/mermaid@11.4.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script async src="/assets/js/data/mathjax.js"></script>
  <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script>


<!-- Pageviews -->

  

  



  <!-- Web Analytics -->
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DZNCWY7GW2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DZNCWY7GW2');
</script>


<!--  -->

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar"><img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">김자바의 개발일지</a>
    <p class="site-subtitle mb-0">🚧 노션 블로그 이전중 🚧</p>
    <a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fsieunnnn.github.io&count_bg=%23575757&title_bg=%23010081&icon=&icon_color=%23E7E7E7&title=%F0%9F%92%BB+%F0%9F%92%A5%E4%B8%89%F0%9F%94%AB%28+%CB%99%EA%92%B3%E2%80%8B%CB%99+%29&edge_flat=false" style="margin-top: 15px"/></a>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <img src="https://sieunnnn.github.io/assets/img/icons/home.png" style="width: 24px; height: 24px; margin-right: 20px"/>
          <span style="font-size: 1.02rem !important;">HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        
        <li class="nav-item">
        <a href="/categories/" class="nav-link">
          
          <img src="https://sieunnnn.github.io/assets/img/icons/categories.png" style="width: 24px; height: 24px; margin-right: 20px"/>
          
          <span style="font-size: 1.02rem !important;">CATEGORIES</span>
        </a>
        </li>
        
      
        
        <li class="nav-item">
        <a href="/tags/" class="nav-link">
          
          <img src="https://sieunnnn.github.io/assets/img/icons/tags.png" style="width: 24px; height: 24px; margin-right: 20px"/>
          
          <span style="font-size: 1.02rem !important;">TAGS</span>
        </a>
        </li>
        
      
        
      
        
        <li class="nav-item">
        <a href="/about/" class="nav-link">
          
          <img src="https://sieunnnn.github.io/assets/img/icons/about.png" style="width: 24px; height: 24px; margin-right: 20px"/>
          
          <span style="font-size: 1.02rem !important;">ABOUT</span>
        </a>
        </li>
        
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap" style="padding: 0 0 15px 0 !important; width:100%; display:flex !important; flex-direction: row !important;  justify-content: center !important; justify-items: center !important; align-content: center !important; background: none !important; box-shadow: none !important; border: none !important;">
    
      
        

      
        <a
          href="https://github.com/sieunnnn"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        style="display: block; margin: 0 auto; background: none !important; box-shadow: none !important; border: none !important; object-fit: contain;"
        >
          
          <img src="https://sieunnnn.github.io/assets/img/icons/github.png" style="width: 26px; height: 26px;" />
        </a>
      
    
        

      
        <a
          href="mailto:wldsmtldsm65@gmail.com"
          aria-label="email"
          

          

          

          
        style="display: block; margin: 0 auto; background: none !important; box-shadow: none !important; border: none !important; object-fit: contain;"
        >
          
          <img src="https://sieunnnn.github.io/assets/img/icons/email.png" style="width: 26px; height: 26px;" />
        </a>
      
    
        

      
        <a
          href="https://www.linkedin.com/in/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        style="display: block; margin: 0 auto; background: none !important; box-shadow: none !important; border: none !important; object-fit: contain;"
        >
          
          <img src="https://sieunnnn.github.io/assets/img/icons/linkedin.png" style="width: 26px; height: 26px;" />
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Stomp 를 사용하여 실시간 서비스 개발하기</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw" style="color: whitesmoke !important; font-size: 14px; margin-bottom: 7px"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

<!--    <button type="button" id="search-trigger" class="btn btn-link">-->
<!--      <i class="fas fa-search fa-fw"></i>-->
<!--    </button>-->

<!--    <search id="search" class="align-items-center ms-3 ms-lg-0">-->
<!--      <i class="fas fa-search fa-fw"></i>-->
<!--      <input-->
<!--        class="form-control"-->
<!--        id="search-input"-->
<!--        type="search"-->
<!--        aria-label="search"-->
<!--        autocomplete="off"-->
<!--        placeholder="Search..."-->
<!--      >-->
<!--    </search>-->
<!--    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">-->
<!--Cancel-->
<!--    </button>-->
  </div>
</header>


        <div class="row flex-grow-1" style="padding: 30px 20px 0 20px">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->


  
  

  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

      
        
        
<!--        -->
      

      

      
    
  
    
      

    
  

  


<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  




<!-- return -->







  
    
      
        
  
        
        
      




<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Stomp 를 사용하여 실시간 서비스 개발하기</h1>
    
      <p class="post-desc fw-light mb-4">실시간 서비스에서 security 는 어떻게 적용해야 할까? 에 대한 고민을 담은 글입니다.</p>
    

    <div class="post-meta text-muted d-flex justify-content-between">
      <!-- published date -->
      <span style="margin-right: 10px">
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1716435180"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May 23, 2024
</time>

      </span>

      <!-- lastmod date -->
      

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3313 words"
>
  <em>18 min</em> read</span>

        </div>
  </header>

<!--  -->
<!--    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">-->
<!--      <span class="label text-truncate">Stomp 를 사용하여 실시간 서비스 개발하기</span>-->
<!--      <button type="button" class="toc-trigger btn me-1">-->
<!--        <i class="fa-solid fa-list-ul fa-fw"></i>-->
<!--      </button>-->
<!--    </div>-->

<!--    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">-->
<!--      <span class="label ps-2 pe-1">Contents</span>-->
<!--      <i class="fa-solid fa-angle-right fa-fw"></i>-->
<!--    </button>-->

<!--    <dialog id="toc-popup" class="p-0">-->
<!--      <div class="header d-flex flex-row align-items-center justify-content-between">-->
<!--        <div class="label text-truncate py-2 ms-4">Stomp 를 사용하여 실시간 서비스 개발하기</div>-->
<!--        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">-->
<!--          <i class="fas fa-close"></i>-->
<!--        </button>-->
<!--      </div>-->
<!--      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>-->
<!--    </dialog>-->
<!--  -->

  <div class="content">
    <h2 id="1-같이-보면-좋은-글"><span class="me-2">1. 같이 보면 좋은 글</span><a href="#1-같이-보면-좋은-글" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h2>
<ol>
  <li><a href="./2023-08-31-exception-custom-by-filter.md">Filter 에 따른 Exception Custom - EntryPoint 란?</a></li>
  <li><a href="./2023-09-01-exception-custom-by-filter2.md">Filter 에 따른 Exception Custom - JWT 예외 처리하기</a></li>
  <li><a href="">동기와 비동기 그리고 ServletHttp~ 와 ServerHttp~ 의 차이 알아보기</a></li>
</ol>

<p><br />
<br /></p>

<h2 id="2-websocket-stomp-기본-설정"><span class="me-2">2. WebSocket Stomp 기본 설정</span><a href="#2-websocket-stomp-기본-설정" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h2>

<blockquote>
  <p>build.gradle 에 웹소켓 dependency 를 추가했다고 가정하고 진행합니다.
<em>spring boot 버전은 3 입니다.</em></p>
</blockquote>

<h3 id="21-websocketconfigurationjava"><span class="me-2">2.1. WebSocketConfiguration.java</span><a href="#21-websocketconfigurationjava" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<blockquote>
  <p>이곳에서는 웹소켓의 엔드포인트와 발행과 구독 주소에 붙는 prefix 를 설정합니다.</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocketMessageBroker</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketConfiguration</span> <span class="kd">implements</span> <span class="nc">WebSocketMessageBrokerConfigurer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomHandshakeHandler</span> <span class="n">customHandshakeHandler</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configureMessageBroker</span><span class="o">(</span><span class="nc">MessageBrokerRegistry</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">config</span><span class="o">.</span><span class="na">enableSimpleBroker</span><span class="o">(</span><span class="s">"/sub"</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setApplicationDestinationPrefixes</span><span class="o">(</span><span class="s">"/pub"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerStompEndpoints</span><span class="o">(</span><span class="nc">StompEndpointRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span>
                <span class="o">.</span><span class="na">addEndpoint</span><span class="o">(</span><span class="s">"/ws"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setAllowedOriginPatterns</span><span class="o">(</span><span class="s">"*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withSockJS</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>위와 같이 설정 파일을 작성한 후,</p>

<ul>
  <li><a href="http://localhost:8080/ws">http://localhost:8080/ws</a> 에 접속하면 웹소켓 연결이 시작됩니다.</li>
  <li>발행 시 맨 앞에 /pub 가 자동으로 붙습니다.</li>
  <li>구독 시 맨 앞에 /sub 가 자동으로 붙습니다.</li>
</ul>

<h3 id="22-messagesecurityconfigurationjava"><span class="me-2">2.2. MessageSecurityConfiguration.java</span><a href="#22-messagesecurityconfigurationjava" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<blockquote>
  <p>이곳에서는 메세지 전송에 대한 인증과 csrf 를 설정합니다.</p>
</blockquote>

<h4 id="221-deprecated---스프링부트-버전에-따른-설정코드-변화"><span class="me-2">2.2.1. deprecated - 스프링부트 버전에 따른 설정코드 변화</span><a href="#221-deprecated---스프링부트-버전에-따른-설정코드-변화" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h4>

<p>스프링 버전이 올라가면서 이전에 아래와 같이 웹소켓 설정을 작성할 경우 <em>AbstractSecurityWebSocketMessageBrokerConfigurer</em> 가 deprecated 되었다는 문구가 나타납니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.messaging.MessageSecurityMetadataSourceRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.socket.AbstractSecurityWebSocketMessageBrokerConfigurer</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageSecurityConfiguration</span> <span class="kd">extends</span> <span class="nc">AbstractSecurityWebSocketMessageBrokerConfigurer</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureInbound</span><span class="o">(</span><span class="nc">MessageSecurityMetadataSourceRegistry</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">messages</span>
                <span class="o">.</span><span class="na">nullDestMatcher</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">simpDestMatchers</span><span class="o">(</span><span class="s">"/pub/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">simpSubscribeDestMatchers</span><span class="o">(</span><span class="s">"/sub/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyMessage</span><span class="o">().</span><span class="na">denyAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">sameOriginDisabled</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// CSRF 보호 비활성화</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>그렇다면 어떻게 수정해야 할까요? Security Configuration 처럼 @Bean 을 사용하여 아래와 같이 작성합니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.SimpMessageType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.ChannelInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authorization.AuthorizationManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.socket.EnableWebSocketSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.messaging.access.intercept.MessageMatcherDelegatingAuthorizationManager</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocketSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageSecurityConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nc">AuthorizationManager</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">authorizationManager</span><span class="o">(</span><span class="nc">MessageMatcherDelegatingAuthorizationManager</span><span class="o">.</span><span class="na">Builder</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">messages</span>
                <span class="o">.</span><span class="na">nullDestMatcher</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">simpTypeMatchers</span><span class="o">(</span><span class="nc">SimpMessageType</span><span class="o">.</span><span class="na">CONNECT</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">simpTypeMatchers</span><span class="o">(</span><span class="nc">SimpMessageType</span><span class="o">.</span><span class="na">SUBSCRIBE</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">simpTypeMatchers</span><span class="o">(</span><span class="nc">SimpMessageType</span><span class="o">.</span><span class="na">MESSAGE</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyMessage</span><span class="o">().</span><span class="na">denyAll</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">messages</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"csrfChannelInterceptor"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ChannelInterceptor</span> <span class="nf">csrfChannelInterceptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ChannelInterceptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>위와 같이 코드를 작성할 경우,</p>

<h5 id="1-nulldestmatcherpermitall"><span class="me-2">1. nullDestMatcher().permitAll()</span><a href="#1-nulldestmatcherpermitall" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>
<p>목적지가 없는 메시지에 대해 모든 사용자에게 접근을 허용합니다.</p>

<h5 id="2-simptypematcherssimpmessagetypeconnectpermitall"><span class="me-2">2. simpTypeMatchers(SimpMessageType.CONNECT).permitAll()</span><a href="#2-simptypematcherssimpmessagetypeconnectpermitall" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>
<p><code>CONNECT</code> 유형의 메시지에 대해 모든 사용자에게 접근을 허용합니다.</p>

<h5 id="3-simptypematcherssimpmessagetypesubscribepermitall"><span class="me-2">3. simpTypeMatchers(SimpMessageType.SUBSCRIBE).permitAll()</span><a href="#3-simptypematcherssimpmessagetypesubscribepermitall" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>
<p><code>SUBSCRIBE</code> 유형의 메시지에 대해 모든 사용자에게 접근을 허용합니다.</p>

<h5 id="4-simptypematcherssimpmessagetypemessagepermitall"><span class="me-2">4. simpTypeMatchers(SimpMessageType.MESSAGE).permitAll()</span><a href="#4-simptypematcherssimpmessagetypemessagepermitall" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>
<p>MESSAGE` 유형의 메시지에 대해 모든 사용자에게 접근을 허용합니다.</p>

<h5 id="5-anymessagedenyall"><span class="me-2">5. anyMessage().denyAll()</span><a href="#5-anymessagedenyall" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>
<p>위에서 명시적으로 허용한 메시지 유형을 제외한 모든 메시지에 대해서는 접근을 거부합니다.</p>

<p><br />
<br /></p>

<h2 id="3-websocket-관련-사용자-인증인가는-어떻게-해야-할까"><span class="me-2">3. WebSocket 관련 사용자 인증/인가는 어떻게 해야 할까?</span><a href="#3-websocket-관련-사용자-인증인가는-어떻게-해야-할까" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h2>

<p>저의 프로젝트의 경우 유저가 jwt 토큰을 넣어 요청을 보내면 jwt 인증 필터 → 시큐리티 필터를 거쳐 유저가 인증이 되고 요청한 리소스를 받는 인가과정을 거치게 됩니다. 하지만 jwt 인증 필터와 시큐리티 필터에서 <a href="http://localhost:8080/ws">http://localhost:8080/ws</a> 요청 또한 인증 절차를 거칠 수 있을까요?</p>

<h3 id="31-일반-요청과-websocket-요청의-구조"><span class="me-2">3.1. 일반 요청과 websocket 요청의 구조</span><a href="#31-일반-요청과-websocket-요청의-구조" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>일반 http 요청의 경우 토큰을 넣어 요청을 보내면 jwt 인증 필터에서 토큰을 검증하고, 유효한 경우 시큐리티 필터를 거쳐 유저 인증을 마칩니다. 그리고 후에 요청한 리소스를 응답으로 보내주게 되죠. 하지만 웹소켓의 경우 이런식으로 요청 → 응답 → 연결 해제 가 반복되는 구조가 아닙니다. 아래와 같이 한번 연결 된후 특정 주소를 구독할 경우, 해당 주소로 발행된 메세지를 지속적으로 받을 수 있습니다.</p>

<p><a href="/assets/post/post-img37.png" class="popup img-link  shimmer"><img src="/assets/post/post-img37.png" width="600px" loading="lazy"></a></p>

<h3 id="32-첫번째-생각한-방식"><span class="me-2">3.2. 첫번째 생각한 방식</span><a href="#32-첫번째-생각한-방식" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>웹소켓 과정에서 인터셉터를 만들어서 인증 / 구독 / 발행 과정에서 인증과정을 거칠까? 하는 생각을 했습니다. 그래서 아래와 같이 인터셉터를 작성하고 등록해주었습니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">com.planner.travel.global.jwt.token.TokenAuthenticator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.planner.travel.global.jwt.token.TokenValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.Ordered</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.annotation.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.SimpMessageType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.stomp.StompHeaderAccessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.ChannelInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Component</span>
<span class="nd">@Order</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span> <span class="o">+</span> <span class="mi">99</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketInterceptor</span> <span class="kd">implements</span> <span class="nc">ChannelInterceptor</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenAuthenticator</span> <span class="n">tokenAuthenticator</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Message</span><span class="o">&lt;?&gt;</span> <span class="n">preSend</span><span class="o">(</span><span class="nc">Message</span><span class="o">&lt;?&gt;</span> <span class="n">message</span><span class="o">,</span> <span class="nc">MessageChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StompHeaderAccessor</span> <span class="n">accessor</span> <span class="o">=</span> <span class="nc">StompHeaderAccessor</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">accessor</span><span class="o">.</span><span class="na">getFirstNativeHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Received STOMP Message: "</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"All headers: "</span> <span class="o">+</span> <span class="n">accessor</span><span class="o">.</span><span class="na">toNativeHeaderMap</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Access Token: "</span> <span class="o">+</span> <span class="n">accessToken</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Incoming message type: "</span> <span class="o">+</span> <span class="n">accessor</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="nc">SimpMessageType</span><span class="o">.</span><span class="na">CONNECT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">accessor</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">())</span> <span class="o">||</span>
                <span class="nc">SimpMessageType</span><span class="o">.</span><span class="na">MESSAGE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">accessor</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">())</span> <span class="o">||</span>
                <span class="nc">SimpMessageType</span><span class="o">.</span><span class="na">SUBSCRIBE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">accessor</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">()))</span> <span class="o">{</span>

            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"accessor: "</span> <span class="o">+</span> <span class="n">accessor</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">());</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">accessToken</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">accessToken</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"Bearer "</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">tokenAuthenticator</span><span class="o">.</span><span class="na">getAuthenticationUsingToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
                <span class="n">accessor</span><span class="o">.</span><span class="na">getSessionAttributes</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Invalid or missing Authorization header"</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Invalid or missing Authorization header"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>하지만 이렇게 작성한 경우 매 헤더에 아래와 같이 accessToken 이 그대로 노출되었습니다.</p>

<div class="language-http highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Http" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="err">CONNECT
accept-version:1.1,1.0
heart-beat:10000,10000
authorization:Bearer some_valid_token
</span></pre></td></tr></tbody></table></code></div></div>

<p>헤더가 있다는 것은 편하고 좋지만, 과연 이게 보안적으로 옳을까? 하는 생각이 들었습니다. 연결 / 구독 / 발행 때마다 토큰 인증을 거치 면서 인증정보의 노출 빈도가 생각보다 높을 것 같았기 때문입니다.</p>

<h3 id="33-두번째-생각한-방식-채택-"><span class="me-2">3.3. 두번째 생각한 방식 (<em>채택</em> )</span><a href="#33-두번째-생각한-방식-채택-" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>웹소켓 연결 과정은 다음과 같습니다.</p>

<ol>
  <li><a href="http://localhost:8080/ws">http://localhost:8080/ws</a>?token={token} 엔드포인트로 <code>GET</code> 요청(handshake 요청) 을 합니다.
    <ul>
      <li>서버에서는 이 요청을 핸드셰이크 핸들러(HandshakeHandler)가 처리합니다.</li>
    </ul>
  </li>
  <li>서버는 클라이언트의 핸드셰이크 요청을 검증합니다.</li>
  <li>요청이 유효하면 서버는 HTTP 상태 코드 101(Switching Protocols)을 보내며, 웹소켓 연결로 변경 됩니다.</li>
  <li>클라이언트와 서버는 WebSocket 연결을 통해 메시지를 주고받을 수 있게 됩니다.</li>
</ol>

<p>이 방식을 구현하기 위해서 아래와 같이 HandshakeHanlder 를 custom 해주었습니다.</p>

<h4 id="331-customhandshakehandlerjava"><span class="me-2">3.3.1. CustomHandshakeHandler.java</span><a href="#331-customhandshakehandlerjava" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h4>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">com.planner.travel.global.jwt.token.TokenAuthenticator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.planner.travel.global.jwt.token.TokenExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.planner.travel.global.jwt.token.TokenValidator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.ExpiredJwtException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.InsufficientAuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.WebSocketHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.server.HandshakeFailureException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.server.HandshakeHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomHandshakeHandler</span> <span class="kd">implements</span> <span class="nc">HandshakeHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenExtractor</span> <span class="n">tokenExtractor</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenAuthenticator</span> <span class="n">tokenAuthenticator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenValidator</span> <span class="n">tokenValidator</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">doHandshake</span><span class="o">(</span><span class="nc">ServerHttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServerHttpResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">WebSocketHandler</span> <span class="n">wsHandler</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">HandshakeFailureException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenExtractor</span><span class="o">.</span><span class="na">getAccessTokenFromRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="n">tokenValidator</span><span class="o">.</span><span class="na">validateAccessToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
            <span class="n">tokenAuthenticator</span><span class="o">.</span><span class="na">getAuthenticationUsingToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>

            <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>

            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Authentication: "</span> <span class="o">+</span> <span class="n">authentication</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExpiredJwtException</span> <span class="o">|</span> <span class="nc">InsufficientAuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">setResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">,</span> <span class="s">"TOKEN_01"</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setResponse</span><span class="o">(</span><span class="nc">ServerHttpResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="nc">String</span> <span class="n">errorCode</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">errorMessage</span> <span class="o">=</span> <span class="s">"{\"errorCode\": \""</span> <span class="o">+</span> <span class="n">errorCode</span> <span class="o">+</span> <span class="s">"\"}"</span><span class="o">;</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">errorMessage</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>코드를 자세히 볼까요? 🧐 로직의 순서는 다음과 같습니다.</p>

<h5 id="1-헤더에서-어세스-토큰을-꺼내옵니다"><span class="me-2">1. 헤더에서 어세스 토큰을 꺼내옵니다.</span><a href="#1-헤더에서-어세스-토큰을-꺼내옵니다" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenExtractor</span><span class="o">.</span><span class="na">getAccessTokenFromRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p><strong>TokenExtractor.java</strong></p>

    <div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre>  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.HttpServletRequest</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpRequest</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.web.util.UriComponentsBuilder</span><span class="o">;</span>
    
  <span class="nd">@Component</span>
  <span class="nd">@Slf4j</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenExtractor</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getAccessTokenFromHeader</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">accessTokenFromHeader</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
    
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"AccessToken from header: "</span> <span class="o">+</span> <span class="n">accessTokenFromHeader</span><span class="o">);</span>
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
    
          <span class="k">if</span> <span class="o">(!</span><span class="n">accessTokenFromHeader</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
              <span class="k">return</span> <span class="n">accessTokenFromHeader</span><span class="o">;</span>
          <span class="o">}</span>
    
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getAccessTokenFromRequest</span> <span class="o">(</span><span class="nc">ServerHttpRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getURI</span><span class="o">().</span><span class="na">getQuery</span><span class="o">();</span>
          <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="nc">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="s">"?"</span> <span class="o">+</span> <span class="n">query</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">getQueryParams</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="s">"token"</span><span class="o">);</span>
    
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"AccessToken from request: "</span> <span class="o">+</span> <span class="n">accessToken</span><span class="o">);</span>
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
    
          <span class="k">if</span> <span class="o">(!</span><span class="n">accessToken</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
              <span class="k">return</span> <span class="n">accessToken</span><span class="o">;</span>
          <span class="o">}</span>
    
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
    
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h5 id="2-어세스-토큰을-검증-합니다"><span class="me-2">2. 어세스 토큰을 검증 합니다.</span><a href="#2-어세스-토큰을-검증-합니다" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">tokenValidator</span><span class="o">.</span><span class="na">validateAccessToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p><strong>TokenValidator.java</strong></p>

    <div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>  <span class="nd">@Component</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="nd">@Slf4j</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenValidator</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
    
      <span class="nd">@Autowired</span>
      <span class="kd">private</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">;</span>
    
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validateAccessToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"Bearer "</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
              <span class="o">}</span>
    
              <span class="nc">Jwts</span><span class="o">.</span><span class="na">parserBuilder</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExpiredJwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h5 id="3-유저-정보를-꺼낸-후-시큐리티-에게-넘겨줍니다"><span class="me-2">3. 유저 정보를 꺼낸 후 시큐리티 에게 넘겨줍니다.</span><a href="#3-유저-정보를-꺼낸-후-시큐리티-에게-넘겨줍니다" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">tokenAuthenticator</span><span class="o">.</span><span class="na">getAuthenticationUsingToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p><strong>TokenAuthenticator.java</strong></p>

    <div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>  <span class="kn">import</span> <span class="nn">com.planner.travel.domain.user.entity.User</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.planner.travel.domain.user.repository.UserRepository</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.persistence.EntityNotFoundException</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
    
  <span class="nd">@Component</span>
  <span class="nd">@Slf4j</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenAuthenticator</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SubjectExtractor</span> <span class="n">subjectExtractor</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
    
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getAuthenticationUsingToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">accessToken</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">accessToken</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"Bearer"</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">accessToken</span> <span class="o">=</span> <span class="n">accessToken</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
          <span class="o">}</span>
    
          <span class="nc">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">subjectExtractor</span><span class="o">.</span><span class="na">getUserIdFromToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
          <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">EntityNotFoundException</span><span class="o">();</span>
          <span class="o">}</span>
    
          <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span>
                  <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
          <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authenticationToken</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
    
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h5 id="4-유저-정보가-제대로-들어왔는지-확인합니다"><span class="me-2">4. 유저 정보가 제대로 들어왔는지 확인합니다.</span><a href="#4-유저-정보가-제대로-들어왔는지-확인합니다" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h5>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Authentication: "</span> <span class="o">+</span> <span class="n">authentication</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"==========================================================================="</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="332-️-만약-이-과정에서-에러가-터지면-어떻게-하나요"><span class="me-2">3.3.2. ⚠️ 만약 이 과정에서 에러가 터지면 어떻게 하나요?</span><a href="#332-️-만약-이-과정에서-에러가-터지면-어떻게-하나요" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h4>

<p>이전에 customException 에 관련한 글을 작성한 적이 있습니다.</p>

<ul>
  <li><a href="./2023-08-31-exception-custom-by-filter.md">Filter 에 따른 Exception Custom - EntryPoint 란?</a></li>
  <li><a href="./2023-09-01-exception-custom-by-filter2.md">Filter 에 따른 Exception Custom - JWT 예외 처리하기</a></li>
</ul>

<p>요약해서 말하면, 예외가 어디에서 발생 하느냐 에 따라 예외 처리를 다르게 해야 한다는 겁니다.</p>

<p>웹소켓 연결 과정을 따라 가다 보면 단순히 <a href="http://localhost:8080/ws">http://localhost:8080/ws</a> 로 요청을 보내는 것 같지만, 여러 과정을 거쳐 switching 이 됩니다. 로그를 보다보면 ws?어쩌구 저쩌구 붙는 과정이 계속 되는 것을 알 수 있죠. 때문에 일단 Security 와 JWT 필터를 통과하도록 열어두어야 합니다. <strong>하지만 이렇게 되면 해당 과정에서 나타날 수 있는 예외를 감지하지 못합니다. 하지만 프론트 에게는 에러의 원인을 알려야 하죠.</strong></p>

<p>그래서 발생할 수 있는 예외를 catch 하여 이를 바로 http 응답 바디에 넣어 보내줍니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setResponse</span><span class="o">(</span><span class="nc">ServerHttpResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">HttpStatus</span> <span class="n">status</span><span class="o">,</span> <span class="nc">String</span> <span class="n">errorCode</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json"</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">errorMessage</span> <span class="o">=</span> <span class="s">"{\"errorCode\": \""</span> <span class="o">+</span> <span class="n">errorCode</span> <span class="o">+</span> <span class="s">"\"}"</span><span class="o">;</span>
      <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">errorMessage</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
      <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
 <span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>이전에 custom 한 예외가 있다면 그에 맞추어 알맞은 상태 코드를 반환합니다.</li>
  <li>헤더에 content type 을 명확하게 명시해줍니다.</li>
  <li>에러 메세지 또한 이전에 custom 한 예외와 똑같이 맞추어 줍니다.</li>
  <li>이를 응답 바디에 넣어줍니다.</li>
</ul>

<p><br />
<br /></p>

<h2 id="4-controller-작성하기"><span class="me-2">4. Controller 작성하기</span><a href="#4-controller-작성하기" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h2>

<p>service 와 repository 등은 기존에 작성하던 그대로 작성하면 되지만 컨트롤러는 살짝 다릅니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nd">@Controller</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlanBoxController</span> <span class="o">{</span>
		<span class="o">...</span>

    <span class="nd">@MessageMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/planner/{plannerId}/create"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createDate</span><span class="o">(</span><span class="nd">@DestinationVariable</span> <span class="nc">Long</span> <span class="n">plannerId</span><span class="o">,</span> <span class="nd">@RequestBody</span> <span class="nc">PlanBoxCreateRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">planBoxService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">plannerId</span><span class="o">);</span>

        <span class="n">simpMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">"/sub/planner/"</span> <span class="o">+</span> <span class="n">plannerId</span><span class="o">,</span>
                <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="s">"create-planBox"</span><span class="o">,</span> <span class="s">"message"</span><span class="o">,</span> <span class="n">planBoxService</span><span class="o">.</span><span class="na">getAllPlanBox</span><span class="o">(</span><span class="n">plannerId</span><span class="o">,</span> <span class="s">"my"</span><span class="o">))</span>
        <span class="o">);</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="41-controller"><span class="me-2">4.1. @Controller</span><a href="#41-controller" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>@RestController 가 아닌 <strong>@Controller</strong> 를 사용하여야 합니다.</p>

<h3 id="42-messagemapping"><span class="me-2">4.2. @MessageMapping</span><a href="#42-messagemapping" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>@MessageMapping 을 사용하여 발행 주소를 구분합니다.</p>

<h3 id="43-impmessagingtemplateconvertandsend"><span class="me-2">4.3. impMessagingTemplate.convertAndSend();</span><a href="#43-impmessagingtemplateconvertandsend" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>구독 주소와 보낼 값을 넣어줍니다. Map 을 사용하지 않아도 좋지만, 수많은 데이터들이 오고갈 때를 생각하여 Map 으로 태그를 붙여주었습니다. 이렇게 하면, 프론트가 해당 태그를 뽑아 데이터 처리를 쉽게 할 수 있습니다.</p>

<p><br />
<br /></p>

<h2 id="5-security-설정과-redis-filter-설정하기"><span class="me-2">5. Security 설정과 Redis filter 설정하기</span><a href="#5-security-설정과-redis-filter-설정하기" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h2>

<h3 id="51-jwtauthenticationfilterjava"><span class="me-2">5.1. JWTAuthenticationFilter.java</span><a href="#51-jwtauthenticationfilterjava" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>위에서 작성했다시피 ws 연결시 인증은 다른방식을 사용하므로, 해당 필터에서는 JWT 인증을 회피하도록 해줍니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTAuthenticationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenExtractor</span> <span class="n">tokenExtractor</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenValidator</span> <span class="n">tokenValidator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenAuthenticator</span> <span class="n">tokenAuthenticator</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
                                    <span class="nd">@NotNull</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">String</span> <span class="n">requestURI</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/api/v1/auth/signup"</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/auth/login"</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/auth/logout"</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/api/v1/auth/token"</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/api/v1/oauth"</span><span class="o">)</span> <span class="o">||</span>
                <span class="o">**</span><span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/ws"</span><span class="o">)</span> <span class="o">||**</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/docs"</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/oauth"</span><span class="o">)</span> <span class="o">||</span>
                <span class="n">requestURI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/favicon.ico"</span><span class="o">)</span>
        <span class="o">)</span> <span class="o">{</span>
            <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">tokenExtractor</span><span class="o">.</span><span class="na">getAccessTokenFromHeader</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">accessToken</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">tokenValidator</span><span class="o">.</span><span class="na">validateAccessToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
                <span class="n">tokenAuthenticator</span><span class="o">.</span><span class="na">getAuthenticationUsingToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExpiredJwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
                <span class="n">setResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"TOKEN_01"</span><span class="o">);</span>

                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setResponse</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">String</span> <span class="n">errorCode</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json;charset=UTF-8"</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span>
                <span class="s">"{\"errorCode\" : \""</span> <span class="o">+</span> <span class="n">errorCode</span> <span class="o">+</span> <span class="s">"\"}"</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="52-securityconfigurationjava"><span class="me-2">5.2. SecurityConfiguration.java</span><a href="#52-securityconfigurationjava" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h3>

<p>커스텀 인증시 시큐리티 사용자 인증또한 완료되기 때문에 이곳에서의 시큐리티 인증을 회피하도록 해줍니다.</p>

<div class="language-java highlighter-rouge"><div class="code-header" style="color: black !important;"">
        <span data-label-text="Java" style="color: black !important;"><img src="/assets/img/icons/code.png" width="21px" style="margin-right: 5px"/></span>
      <button aria-label="copy" data-title-succeed="Copied!"><img src="/assets/img/icons/copy.png" width="19px" style="margin-bottom: 4px"/></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomUserDetailsService</span> <span class="n">customUserDetailsService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthenticationConfiguration</span> <span class="n">authenticationConfiguration</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenExtractor</span> <span class="n">tokenExtractor</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenValidator</span> <span class="n">tokenValidator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenAuthenticator</span> <span class="n">tokenAuthenticator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomAuthenticationEntryPoint</span> <span class="n">customAuthenticationEntryPoint</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomOAuth2UserService</span> <span class="n">customOAuth2UserService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OAuth2AuthenticationSuccessHandler</span> <span class="n">oAuth2AuthenticationSuccessHandler</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SecurityFilterChain</span> <span class="nf">securityFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">httpSecurity</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">httpSecurity</span>
                <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="nl">AbstractHttpConfigurer:</span><span class="o">:</span><span class="n">disable</span><span class="o">)</span>
                <span class="o">.</span><span class="na">cors</span><span class="o">(</span><span class="n">cors</span> <span class="o">-&gt;</span> <span class="o">{})</span>
                <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">authorizeRequest</span><span class="o">)</span> <span class="o">-&gt;</span>
                        <span class="n">authorizeRequest</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">OPTIONS</span><span class="o">,</span> <span class="s">"/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/api/v1/auth/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/oauth/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/api/v1/oauth/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/api/v1/auth/token/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/docs/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="s">"/ws/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                                <span class="o">...</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><br />
<br /></p>

<h2 id="6-다시-한번-정리하기"><span class="me-2">6. 다시 한번 정리하기</span><a href="#6-다시-한번-정리하기" class="anchor text-muted" style="text-decoration-line: none !important;" >
           <img src="/assets/img/icons/mouse.png" width="18px" style="margin-bottom: 3px !important;"/>
      </a></h2>

<p>다시 정리하면, 아래와 같은 순서로 만들어보면 좋을것 같아요.</p>

<blockquote>
  <ol>
    <li>웹소켓 dependency 추가</li>
    <li>웹소켓 기본 설정 클래스 추가</li>
    <li>웹소켓 시큐리티 설정 클래스 추가</li>
    <li>웹소켓 인터셉터 클래스 추가 (JWT 토큰을 이용한 security 인증 / 인가 과정)</li>
    <li>연결이후 수행될 service 와 필요한 repository 생성</li>
    <li>controller 생성</li>
  </ol>
</blockquote>

<p>도움이 되었길 바라며 이만 글을 마칩니다.👋🏻</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta">
        <a href="https://sieunnnn.github.io/assets/img/icons/openFolder.png" class="popup img-link  shimmer"><img src="https://sieunnnn.github.io/assets/img/icons/openFolder.png" width="17px" style="text-decoration-line: none !important; margin: 2px 11px 0 3px; height:17px !important;" loading="lazy"></a>
        
          <a href="/categories/spring-boot/" style="text-decoration-line: none !important; margin-top: 2px">Spring boot</a>,
          <a href="/categories/websocket/" style="text-decoration-line: none !important; margin-top: 2px">Websocket</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags" style="margin-top: 6px">
        <a href="https://sieunnnn.github.io/assets/img/icons/tags.png" class="popup img-link  shimmer"><img src="https://sieunnnn.github.io/assets/img/icons/tags.png" width="19px" style="text-decoration-line: none !important; margin: 2px 10px 0 2px; height:19px !important;" loading="lazy"></a>
        
          <a
            href="/tags/websocket/"
            class="post-tag no-text-decoration"
          >websocket</a>
        
          <a
            href="/tags/stomp/"
            class="post-tag no-text-decoration"
          >stomp</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>
    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/2023-09-17-send-find-password-mail/"></a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/2024-04-18-setter-builder-jackson/"></a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/deploy-project-free-using-vercel-and-ngrok/">vercel, ngrok 을 사용하여 무료로 프로젝트 배포하기</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/map-service-using-google-map-api/">google map api 를 사용한 지도 검색과 지도 생성</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/lazy-initialization-exception/">LazyInitializationException 과 SecurityContextHolder</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag" href="/tags/exception/">exception</a>
      
        
        <a class="post-tag" href="/tags/github-actions/">github actions</a>
      
        
        <a class="post-tag" href="/tags/security/">security</a>
      
        
        <a class="post-tag" href="/tags/%EC%9E%90%EB%8F%99%EB%B0%B0%ED%8F%AC/">자동배포</a>
      
        
        <a class="post-tag" href="/tags/docker/">docker</a>
      
        
        <a class="post-tag" href="/tags/stomp/">stomp</a>
      
        
        <a class="post-tag" href="/tags/websocket/">websocket</a>
      
        
        <a class="post-tag" href="/tags/%ED%98%91%EC%97%85/">협업</a>
      
        
        <a class="post-tag" href="/tags/jwt/">JWT</a>
      
        
        <a class="post-tag" href="/tags/spring-boot-3/">spring boot 3</a>
      
    </div>
  </section>


            </div>

            
              
              


  
    
      
        
  
        
        
      





  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/servlet-http-and-server-http/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1718767980"
  data-df="ll"
  
>
  Jun 19, 2024
</time>

              <h4 class="pt-0 my-2">동기와 비동기 그리고 ServletHttp~ 와 ServerHttp~ 의 차이 알아보기</h4>
              <div class="text-muted">
                <p>동기와 비동기, 그리고 이번에 알게된 ServerHttp~ 에 대해 알려드려요.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/websocket-tester/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1716953580"
  data-df="ll"
  
>
  May 29, 2024
</time>

              <h4 class="pt-0 my-2">websocket stomp 테스터 만들기 with sock.js</h4>
              <div class="text-muted">
                <p>내 환경에 맞으면서 프로젝트 인증방식에 맞는 websocket 테스터가 없었다. 그래서 만들었다.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/record-and-dto/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1713497580"
  data-df="ll"
  
>
  Apr 19, 2024
</time>

              <h4 class="pt-0 my-2">Record 와 DTO</h4>
              <div class="text-muted">
                <p>자바 버전을 올렸는데 Record 가 생겼어요.</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/watch-out-when-using-github-actions/"
      class="btn"
      aria-label="Older"
    >
      <p>Github Actions 를 사용하여 Image build, push 자동화 시 유의해야 할 보안 문제</p>
    </a>
  

  
    <a
      href="/posts/mail-service/"
      class="btn"
      aria-label="Newer"
    >
      <p>메일 서비스 만들기 with Google SMTP</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://github.com/sieunnnn">김자바</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.2.4"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag" href="/tags/exception/">exception</a>
      
        
        <a class="post-tag" href="/tags/github-actions/">github actions</a>
      
        
        <a class="post-tag" href="/tags/security/">security</a>
      
        
        <a class="post-tag" href="/tags/%EC%9E%90%EB%8F%99%EB%B0%B0%ED%8F%AC/">자동배포</a>
      
        
        <a class="post-tag" href="/tags/docker/">docker</a>
      
        
        <a class="post-tag" href="/tags/stomp/">stomp</a>
      
        
        <a class="post-tag" href="/tags/websocket/">websocket</a>
      
        
        <a class="post-tag" href="/tags/%ED%98%91%EC%97%85/">협업</a>
      
        
        <a class="post-tag" href="/tags/jwt/">JWT</a>
      
        
        <a class="post-tag" href="/tags/spring-boot-3/">spring boot 3</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

